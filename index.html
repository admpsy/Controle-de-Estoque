<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Movimentação</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #4b6cb7;
            --secondary-color: #182848;
            --accent-color: #6a11cb;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #121212;
            --dark-bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-color: #f8f9fa;
            --text-muted: #b0b0b0;
            --text-light: #ffffff;
            --border-color: #444;
            --sidebar-width: 280px;
            --table-header-bg: #343a40;
            --table-row-hover: rgba(255, 255, 255, 0.08);
            --table-striped: rgba(255, 255, 255, 0.05);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--secondary-color) 0%, var(--dark-bg) 100%);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar-header h3 {
            color: var(--text-light);
            font-weight: 600;
            margin: 0;
        }

        .logo-icon {
            color: var(--primary-color);
            margin-right: 0.5rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-link {
            color: var(--text-muted);
            padding: 0.75rem 1.5rem;
            border-radius: 0;
            transition: var(--transition);
            border-left: 4px solid transparent;
            font-weight: 500;
        }

        .nav-link:hover, 
        .nav-link.active {
            color: var(--text-light);
            background: linear-gradient(90deg, rgba(75, 108, 183, 0.2) 0%, transparent 100%);
            border-left: 4px solid var(--primary-color);
            transform: translateX(5px);
        }

        .nav-link i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
            transition: var(--transition);
            color: var(--text-muted);
        }

        .nav-link:hover i,
        .nav-link.active i {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            min-height: 100vh;
            transition: var(--transition);
            background: var(--light-bg);
            color: var(--text-color);
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            transition: var(--transition);
            color: var(--text-color);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            color: var(--text-light);
        }

        .card-title {
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 0;
        }

        .card-body {
            color: var(--text-color);
        }

        .table {
            color: var(--text-color);
            margin-bottom: 0;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .table th {
            background: linear-gradient(135deg, var(--table-header-bg) 0%, var(--dark-bg) 100%);
            border-color: var(--border-color);
            color: var(--text-light);
            font-weight: 600;
            padding: 1rem 0.75rem;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
        }

        .table td {
            border-color: var(--border-color);
            vertical-align: middle;
            padding: 0.75rem;
            transition: var(--transition);
            color: var(--text-color);
            background-color: transparent;
        }

        .table tbody tr {
            background-color: var(--card-bg);
        }

        .table tbody tr:hover {
            background-color: var(--table-row-hover);
            transform: scale(1.01);
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: var(--table-striped);
        }

        .form-control, 
        .form-select {
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
            padding: 0.75rem 1rem;
        }

        .form-control:focus, 
        .form-select:focus {
            background-color: var(--dark-bg);
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.25rem rgba(75, 108, 183, 0.25);
            transform: translateY(-1px);
        }

        .form-label {
            color: var(--text-light);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-text {
            color: var(--text-muted) !important;
        }

        .btn {
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: var(--transition);
            padding: 0.75rem 1.5rem;
            border: none;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a5a9e 0%, #5a0fb5 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            color: white;
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
            color: #212529;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #e83e8c 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #6f42c1 100%);
            color: white;
        }

        .btn-outline-secondary {
            color: var(--text-muted);
            border: 2px solid var(--text-muted);
            background: transparent;
        }

        .btn-outline-secondary:hover {
            background: var(--text-muted);
            color: var(--dark-bg);
        }

        .status-valid {
            color: var(--success-color);
            font-weight: 600;
        }

        .status-warning {
            color: var(--warning-color);
            font-weight: 600;
        }

        .status-expired {
            color: var(--danger-color);
            font-weight: 600;
        }

        .badge {
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
        }

        .badge-status-ativo {
            background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
            color: #212529;
        }

        .badge-status-liberado {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
            color: white;
        }

        .badge-status-descartado {
            background: linear-gradient(135deg, var(--danger-color) 0%, #e83e8c 100%);
            color: white;
        }

        .badge.bg-success,
        .badge.bg-primary,
        .badge.bg-warning,
        .badge.bg-danger,
        .badge.bg-info {
            color: white;
        }

        .photo-preview {
            display: inline-block;
            position: relative;
            margin: 5px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .photo-preview:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .photo-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        .photo-preview .remove-photo {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, var(--danger-color) 0%, #e83e8c 100%);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            border: 2px solid var(--card-bg);
            transition: var(--transition);
        }

        .photo-preview .remove-photo:hover {
            transform: scale(1.1);
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }

        .toast {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            color: var(--text-color);
        }

        .toast-header {
            background: linear-gradient(135deg, var(--dark-bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
        }

        .toast-body {
            color: var(--text-color);
        }

        .stat-card {
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            border: none;
            position: relative;
            overflow: hidden;
            color: white;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .stat-card .card-body {
            padding: 1.5rem;
            position: relative;
            z-index: 1;
            color: white;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.9;
            margin-bottom: 1rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            color: white;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            color: white;
        }

        .stat-title {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }

        .bg-gradient-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
        }

        .bg-gradient-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #fd7e14 100%);
        }

        .bg-gradient-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #e83e8c 100%);
        }

        .bg-gradient-info {
            background: linear-gradient(135deg, var(--info-color) 0%, #6f42c1 100%);
        }

        .accordion-button {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--dark-bg) 100%);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            font-weight: 500;
            transition: var(--transition);
        }

        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            box-shadow: none;
        }

        .accordion-button::after {
            filter: invert(1);
        }

        .accordion-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius) !important;
            overflow: hidden;
        }

        .accordion-body {
            background: var(--dark-bg);
            color: var(--text-color);
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            color: var(--text-color);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--dark-bg) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
        }

        .modal-footer {
            background: var(--dark-bg);
            border-top: 1px solid var(--border-color);
        }

        .modal-body {
            color: var(--text-color);
        }

        .btn-close {
            filter: invert(1);
        }

        .stock-group {
            background: var(--card-bg);
            transition: var(--transition);
            color: var(--text-color);
        }

        .stock-group:hover {
            background: var(--table-row-hover);
        }

        .batch-detail {
            background: var(--dark-bg);
            transition: var(--transition);
            color: var(--text-color);
        }

        .batch-detail:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .expand-btn {
            transition: var(--transition);
            color: var(--text-color);
        }

        .expand-btn:hover {
            transform: scale(1.1);
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-light);
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .form-control::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .form-control:disabled,
        .form-select:disabled {
            background-color: var(--dark-bg);
            color: var(--text-muted);
            opacity: 0.6;
        }

        .table .badge {
            color: white !important;
        }

        .table .btn {
            color: inherit;
        }

        .modal-content .form-label {
            color: var(--text-light);
        }

        .modal-content .form-control,
        .modal-content .form-select {
            color: var(--text-color);
            background-color: var(--dark-bg);
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar .nav-text {
                display: none;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .sidebar-header h3 {
                display: none;
            }
            
            .sidebar-header .logo-icon {
                font-size: 1.5rem;
            }
            
            .stat-number {
                font-size: 2rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 0.5rem;
            }
            
            .nav-item {
                flex-shrink: 0;
            }
            
            .nav-link {
                white-space: nowrap;
                border-left: none;
                border-bottom: 4px solid transparent;
                padding: 0.5rem 1rem;
            }
            
            .nav-link.active {
                border-left: none;
                border-bottom: 4px solid var(--primary-color);
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .stat-card .card-body {
                padding: 1rem;
            }
            
            .stat-number {
                font-size: 1.75rem;
            }
            
            .stat-icon {
                font-size: 2rem;
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        * {
            color: inherit;
        }

        body * {
            color: var(--text-color);
        }

        .card,
        .table td,
        .table th,
        .modal-content,
        .accordion-item,
        .toast {
            opacity: 1 !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="bi bi-box-seam logo-icon"></i> <span class="nav-text">Controle de Movimentação</span></h3>
        </div>
        <div class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-target="dashboard">
                        <i class="bi bi-speedometer2"></i> <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="movimentacao">
                        <i class="bi bi-arrow-left-right"></i> <span class="nav-text">Movimentação</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="estoque">
                        <i class="bi bi-boxes"></i> <span class="nav-text">Estoque</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="produtos-segregados">
                        <i class="bi bi-shield-exclamation"></i> <span class="nav-text">Produtos Segregados</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="paletes">
                        <i class="bi bi-palette"></i> <span class="nav-text">Paletes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="relatorios">
                        <i class="bi bi-file-earmark-text"></i> <span class="nav-text">Relatórios</span>
                    </a>
                </li>
            </ul>
        </div>
        <div class="p-3">
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" id="syncButton">
                    <i class="bi bi-cloud-arrow-up"></i> <span class="nav-text">Sincronizar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard -->
        <div id="dashboard" class="module-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Dashboard</h2>
                <div class="d-flex">
                    <span class="badge bg-success me-2" id="syncStatus">Sincronizado</span>
                    <span class="badge bg-secondary" id="currentDate"></span>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card bg-gradient-primary text-white">
                        <div class="card-body">
                            <div class="stat-icon">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div class="stat-number" id="totalProdutos">0</div>
                            <div class="stat-title">Total de Produtos</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card bg-gradient-success text-white">
                        <div class="card-body">
                            <div class="stat-icon">
                                <i class="bi bi-arrow-down-circle"></i>
                            </div>
                            <div class="stat-number" id="entradasDia">0</div>
                            <div class="stat-title">Entradas do Dia</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card bg-gradient-warning text-white">
                        <div class="card-body">
                            <div class="stat-icon">
                                <i class="bi bi-arrow-up-circle"></i>
                            </div>
                            <div class="stat-number" id="saidasDia">0</div>
                            <div class="stat-title">Saídas do Dia</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card stat-card bg-gradient-danger text-white">
                        <div class="card-body">
                            <div class="stat-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div class="stat-number" id="alertasAtivos">0</div>
                            <div class="stat-title">Alertas Ativos</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Movimentações Recentes</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Produto</th>
                                            <th>Tipo</th>
                                            <th>Quantidade</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentMovementsTable">
                                        <!-- Dados serão preenchidos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Status de Produtos</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Lote</th>
                                            <th>Status</th>
                                            <th>Vencimento</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productStatusTable">
                                        <!-- Dados serão preenchidos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Produtos com Vencimento Próximo ou Vencidos</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Lote</th>
                                            <th>Quantidade</th>
                                            <th>Fabricacao</th>
                                            <th>Vencimento</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expiringProductsTable">
                                        <!-- Dados serão preenchidos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movimentação -->
        <div id="movimentacao" class="module-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Cadastro de Movimentação</h2>
                <button class="btn btn-primary" id="generateReportBtn">
                    <i class="bi bi-file-earmark-pdf"></i> Gerar Relatório
                </button>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Formulário de Movimentação</h5>
                </div>
                <div class="card-body">
                    <form id="movementForm">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="movementDate" class="form-label">Data</label>
                                <input type="date" class="form-control" id="movementDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="movementType" class="form-label">Tipo de Movimento</label>
                                <select class="form-select" id="movementType" required>
                                    <option value="">Selecione...</option>
                                    <option value="Entrada">Entrada</option>
                                    <option value="Saída">Saída</option>
                                    <option value="Devolução">Devolução</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="productSearch" class="form-label">Produto</label>
                                <input type="text" class="form-control" id="productSearch" placeholder="Digite para buscar produto..." list="productList">
                                <datalist id="productList">
                                    <!-- Opções serão preenchidas via JavaScript -->
                                </datalist>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="productSKU" class="form-label">SKU</label>
                                <input type="text" class="form-control" id="productSKU" readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="productName" class="form-label">Nome do Produto</label>
                                <input type="text" class="form-control" id="productName" readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="productType" class="form-label">Tipo</label>
                                <input type="text" class="form-control" id="productType" readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="availableQuantity" class="form-label">Disponível</label>
                                <input type="text" class="form-control" id="availableQuantity" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="batch" class="form-label">Lote</label>
                                <select class="form-select" id="batch" required>
                                    <option value="">Selecione...</option>
                                    <!-- Opções serão preenchidas via JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="manufacturingDate" class="form-label">Data de Fabricação</label>
                                <input type="date" class="form-control" id="manufacturingDate" required>
                            </div>
                            <div class="col-md-3">
                                <label for="quantity" class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="quantity" min="1" required>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" id="addItemBtn">
                                    <i class="bi bi-plus-circle"></i> Adicionar Item
                                </button>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="photos" class="form-label">Fotos (opcional)</label>
                                <input type="file" class="form-control" id="photos" multiple accept="image/*">
                                <div class="form-text">Selecione até 5 fotos (JPEG, PNG)</div>
                                <div id="photoPreview" class="mt-2"></div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Itens Adicionados</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Lote</th>
                                    <th>Quantidade</th>
                                    <th>Tipo Mov.</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTable">
                                <!-- Itens serão adicionados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <strong>Total de Itens: <span id="totalItems">0</span></strong>
                        </div>
                        <div>
                            <button class="btn btn-success" id="saveMovementBtn">
                                <i class="bi bi-check-circle"></i> Salvar Movimentação
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estoque -->
        <div id="estoque" class="module-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Estoque de Produtos</h2>
                <div class="d-flex">
                    <input type="text" class="form-control me-2" id="searchStock" placeholder="Buscar por SKU ou nome...">
                    <button class="btn btn-outline-primary" id="filterStockBtn">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Produtos em Estoque</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>SKU</th>
                                    <th>Produto</th>
                                    <th>Tipo</th>
                                    <th>Quantidade Total</th>
                                    <th>Lotes</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="stockTable">
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Produtos Segregados -->
        <div id="produtos-segregados" class="module-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Produtos Segregados</h2>
                <button class="btn btn-primary" id="newSegregatedBtn">
                    <i class="bi bi-plus-circle"></i> Novo Produto Segregado
                </button>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Status</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">Todos</option>
                                <option value="ativo">Ativo</option>
                                <option value="liberado">Liberado</option>
                                <option value="descartado">Descartado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterReason" class="form-label">Motivo</label>
                            <select class="form-select" id="filterReason">
                                <option value="">Todos</option>
                                <option value="qualidade">Controle de Qualidade</option>
                                <option value="quarentena">Quarentena</option>
                                <option value="nao-conformidade">Não Conformidade</option>
                                <option value="retorno-cliente">Retorno de Cliente</option>
                                <option value="analise-tecnica">Análise Técnica</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterResponsible" class="form-label">Responsável</label>
                            <input type="text" class="form-control" id="filterResponsible" placeholder="Nome do responsável">
                        </div>
                        <div class="col-md-3">
                            <label for="filterDate" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="filterDate">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary" id="applyFiltersBtn">Aplicar Filtros</button>
                            <button class="btn btn-outline-secondary" id="clearFiltersBtn">Limpar Filtros</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Lista de Produtos Segregados</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>SKU</th>
                                    <th>Produto</th>
                                    <th>Lote</th>
                                    <th>Quantidade</th>
                                    <th>Motivo</th>
                                    <th>Localização</th>
                                    <th>Responsável</th>
                                    <th>Data Início</th>
                                    <th>Previsão</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="segregatedTable">
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paletes -->
        <div id="paletes" class="module-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Movimentação de Paletes</h2>
                <button class="btn btn-primary" id="newPaleteBtn">
                    <i class="bi bi-plus-circle"></i> Nova Movimentação
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Relatórios de Paletes</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="paletesAccordion">
                        <!-- Relatórios serão adicionados via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Relatórios -->
        <div id="relatorios" class="module-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Relatórios de Estoque</h2>
                <div class="d-flex">
                    <input type="date" class="form-control me-2" id="reportDateFilter">
                    <button class="btn btn-outline-primary me-2" id="filterReportsBtn">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                    <button class="btn btn-primary" id="exportReportsBtn">
                        <i class="bi bi-file-earmark-excel"></i> Exportar
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Histórico de Relatórios</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nº Relatório</th>
                                    <th>Data</th>
                                    <th>Itens</th>
                                    <th>Tipo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTable">
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Produtos Segregados -->
    <div class="modal fade" id="segregatedModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="segregatedModalTitle">Novo Produto Segregado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="segregatedForm">
                        <input type="hidden" id="segregatedId">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="segregatedSKU" class="form-label">SKU</label>
                                <input type="text" class="form-control" id="segregatedSKU" required>
                            </div>
                            <div class="col-md-6">
                                <label for="segregatedProduct" class="form-label">Produto</label>
                                <input type="text" class="form-control" id="segregatedProduct" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="segregatedType" class="form-label">Tipo</label>
                                <select class="form-select" id="segregatedType" required>
                                    <option value="">Selecione...</option>
                                    <option value="Tambor">Tambor</option>
                                    <option value="Balde">Balde</option>
                                    <option value="Bombona">Bombona</option>
                                    <option value="IBC1000L">IBC 1000L</option>
                                    <option value="Caixa">Caixa</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="segregatedQuantity" class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="segregatedQuantity" min="1" required>
                            </div>
                            <div class="col-md-4">
                                <label for="segregatedBatch" class="form-label">Lote</label>
                                <input type="text" class="form-control" id="segregatedBatch" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="segregatedManufacturingDate" class="form-label">Data de Fabricação</label>
                                <input type="date" class="form-control" id="segregatedManufacturingDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="segregatedReason" class="form-label">Motivo da Segregação</label>
                                <select class="form-select" id="segregatedReason" required>
                                    <option value="">Selecione...</option>
                                    <option value="qualidade">Controle de Qualidade</option>
                                    <option value="quarentena">Quarentena</option>
                                    <option value="nao-conformidade">Não Conformidade</option>
                                    <option value="retorno-cliente">Retorno de Cliente</option>
                                    <option value="analise-tecnica">Análise Técnica</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="otherReasonContainer" style="display: none;">
                            <div class="col-12">
                                <label for="segregatedOtherReason" class="form-label">Especificar Outro Motivo</label>
                                <input type="text" class="form-control" id="segregatedOtherReason">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="segregatedLocation" class="form-label">Localização</label>
                                <input type="text" class="form-control" id="segregatedLocation" required>
                            </div>
                            <div class="col-md-6">
                                <label for="segregatedResponsible" class="form-label">Responsável</label>
                                <input type="text" class="form-control" id="segregatedResponsible" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="segregatedStartDate" class="form-label">Data de Início</label>
                                <input type="date" class="form-control" id="segregatedStartDate" required>
                            </div>
                            <div class="col-md-4">
                                <label for="segregatedExpectedDate" class="form-label">Previsão de Liberação</label>
                                <input type="date" class="form-control" id="segregatedExpectedDate">
                            </div>
                            <div class="col-md-4">
                                <label for="segregatedStatus" class="form-label">Status</label>
                                <select class="form-select" id="segregatedStatus" required>
                                    <option value="ativo">Ativo</option>
                                    <option value="liberado">Liberado</option>
                                    <option value="descartado">Descartado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="segregatedObservations" class="form-label">Observações</label>
                                <textarea class="form-control" id="segregatedObservations" rows="3" maxlength="500"></textarea>
                                <div class="form-text"><span id="charCount">0</span>/500 caracteres</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="segregatedPhotos" class="form-label">Fotos</label>
                                <input type="file" class="form-control" id="segregatedPhotos" multiple accept="image/*">
                                <div class="form-text">Mínimo 1 foto, máximo 5</div>
                                <div id="segregatedPhotoPreview" class="mt-2"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveSegregatedBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Paletes -->
    <div class="modal fade" id="paleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paleteModalTitle">Nova Movimentação de Palete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paleteForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="paleteDate" class="form-label">Data</label>
                                <input type="date" class="form-control" id="paleteDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="paleteType" class="form-label">Tipo de Palete</label>
                                <select class="form-select" id="paleteType" required>
                                    <option value="">Selecione...</option>
                                    <option value="Fracionado">Fracionado</option>
                                    <option value="Tambor">Tambor</option>
                                    <option value="IBC 1000L">IBC 1000L</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="paleteMovement" class="form-label">Tipo de Movimento</label>
                                <select class="form-select" id="paleteMovement" required>
                                    <option value="">Selecione...</option>
                                    <option value="Entrada">Entrada</option>
                                    <option value="Saída">Saída</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="paleteQuantity" class="form-label">Quantidade</label>
                                <input type="number" class="form-control" id="paleteQuantity" min="1" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="savePaleteBtn">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status de Sincronização -->
    <div class="sync-status">
        <div class="toast" id="syncToast">
            <div class="toast-header">
                <strong class="me-auto">Status de Sincronização</strong>
                <small>Agora</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="syncToastBody">
                Sincronizado com sucesso!
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script Principal -->
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDOy0Ylpkkq9GZQLJmmpfkLwCorptjceV4",
            authDomain: "controlemovimentacao-cbd0d.firebaseapp.com",
            projectId: "controlemovimentacao-cbd0d",
            storageBucket: "controlemovimentacao-cbd0d.firebasestorage.app",
            messagingSenderId: "607751879879",
            appId: "1:607751879879:web:0b1bfd6f0beb95b95812e2"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);

        // Referências para os serviços
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Inicialização do sistema
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data atual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('currentDate').textContent = formatDate(today);
            document.getElementById('movementDate').value = today;
            document.getElementById('segregatedStartDate').value = today;
            document.getElementById('paleteDate').value = today;
            
            // Inicializar módulos
            initializeDashboard();
            initializeMovimentacao();
            initializeEstoque();
            initializeProdutosSegregados();
            initializePaletes();
            initializeRelatorios();
            
            // Configurar navegação
            setupNavigation();
            
            // Configurar sincronização
            setupSync();
            
            // Carregar dados iniciais
            loadInitialData();
        });

        // Configuração de navegação
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const moduleContents = document.querySelectorAll('.module-content');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remover classe active de todos os links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Adicionar classe active ao link clicado
                    this.classList.add('active');
                    
                    // Ocultar todos os módulos
                    moduleContents.forEach(content => content.classList.add('d-none'));
                    
                    // Mostrar o módulo correspondente
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).classList.remove('d-none');
                });
            });
        }

        // Configuração de sincronização
        function setupSync() {
            const syncButton = document.getElementById('syncButton');
            const syncToast = new bootstrap.Toast(document.getElementById('syncToast'));
            
            syncButton.addEventListener('click', function() {
                syncButton.disabled = true;
                syncButton.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> <span class="nav-text">Sincronizando...</span>';
                
                // Simular sincronização
                setTimeout(() => {
                    syncButton.disabled = false;
                    syncButton.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> <span class="nav-text">Sincronizar</span>';
                    
                    document.getElementById('syncToastBody').textContent = 'Dados sincronizados com sucesso!';
                    syncToast.show();
                    
                    document.getElementById('syncStatus').textContent = 'Sincronizado';
                    document.getElementById('syncStatus').className = 'badge bg-success me-2';
                }, 2000);
            });
        }

        // Carregar dados iniciais
        function loadInitialData() {
            // Carregar dados do localStorage ou inicializar com dados de exemplo
            if (!localStorage.getItem('productsData')) {
                initializeSampleData();
            }
            
            // Atualizar dashboard
            updateDashboard();
            
            // Atualizar estoque
            updateStockTable();
            
            // Atualizar produtos segregados
            updateSegregatedTable();
            
            // Atualizar relatórios
            updateReportsTable();
        }

        // Inicializar dados de exemplo
        function initializeSampleData() {
            const sampleProducts = [
                {
                    SKU: "PROD001",
                    Produto: "Resina Epóxi",
                    Tipo: "Tambor",
                    Quantidade: 150,
                    Lote: "LOTE001",
                    "Data Fabricação": "2023-01-15",
                    Entradas: 200,
                    Saídas: 50,
                    id: 1
                },
                {
                    SKU: "PROD002",
                    Produto: "Adesivo Industrial",
                    Tipo: "Balde",
                    Quantidade: 75,
                    Lote: "LOTE002",
                    "Data Fabricação": "2023-02-20",
                    Entradas: 100,
                    Saídas: 25,
                    id: 2
                },
                {
                    SKU: "PROD003",
                    Produto: "Solvente Limpeza",
                    Tipo: "Bombona",
                    Quantidade: 200,
                    Lote: "LOTE003",
                    "Data Fabricação": "2023-03-10",
                    Entradas: 250,
                    Saídas: 50,
                    id: 3
                }
            ];
            
            const sampleMovements = [
                {
                    id: 1,
                    timestamp: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0],
                    movementType: "Entrada",
                    productSKU: "PROD001",
                    productName: "Resina Epóxi",
                    quantity: 50,
                    productType: "Tambor",
                    batch: "LOTE001",
                    manufacturingDate: "2023-01-15",
                    quantidadeProcessada: 50,
                    remainingQuantity: 0,
                    lotesUtilizados: []
                }
            ];
            
            const sampleReports = [
                {
                    reportNumber: 1,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    items: sampleMovements
                }
            ];
            
            localStorage.setItem('productsData', JSON.stringify(sampleProducts));
            localStorage.setItem('movementHistory', JSON.stringify(sampleMovements));
            localStorage.setItem('reportsHistory', JSON.stringify(sampleReports));
            localStorage.setItem('lastReportNumber', '1');
            localStorage.setItem('lastPaletesReportNumber', '1');
            localStorage.setItem('segregatedProducts', JSON.stringify([]));
            localStorage.setItem('paletesData', JSON.stringify([]));
        }

        // Funções utilitárias
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function calcularVencimento(dataFabricacao) {
            const data = new Date(dataFabricacao);
            data.setFullYear(data.getFullYear() + 4);
            return data.toISOString().split('T')[0];
        }

        function verificarStatusProduto(dataVencimento) {
            const hoje = new Date();
            const vencimento = new Date(dataVencimento);
            const umAnoAntes = new Date(vencimento);
            umAnoAntes.setFullYear(umAnoAntes.getFullYear() - 1);
            
            if (hoje > vencimento) {
                return { status: "Vencido", class: "status-expired" };
            } else if (hoje > umAnoAntes) {
                return { status: "Vencimento Próximo", class: "status-warning" };
            } else {
                return { status: "Dentro do Prazo", class: "status-valid" };
            }
        }

        // Módulo Dashboard
        function initializeDashboard() {
            console.log("Dashboard inicializado");
        }

        function updateDashboard() {
            // Obter dados do localStorage
            const products = JSON.parse(localStorage.getItem('productsData') || '[]');
            const movements = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            const segregated = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            
            // Calcular estatísticas
            const totalProdutos = products.reduce((sum, product) => sum + product.Quantidade, 0);
            
            const today = new Date().toISOString().split('T')[0];
            const entradasDia = movements
                .filter(m => m.date === today && m.movementType === 'Entrada')
                .reduce((sum, m) => sum + m.quantity, 0);
            
            const saidasDia = movements
                .filter(m => m.date === today && m.movementType === 'Saída')
                .reduce((sum, m) => sum + m.quantity, 0);
            
            const alertasAtivos = segregated.filter(p => p.StatusSegregacao === 'ativo').length;
            
            // Atualizar cards
            document.getElementById('totalProdutos').textContent = totalProdutos;
            document.getElementById('entradasDia').textContent = entradasDia;
            document.getElementById('saidasDia').textContent = saidasDia;
            document.getElementById('alertasAtivos').textContent = alertasAtivos;
            
            // Atualizar tabela de movimentações recentes
            updateRecentMovementsTable(movements);
            
            // Atualizar tabela de status de produtos
            updateProductStatusTable(products);
            
            // Atualizar tabela de produtos com vencimento próximo
            updateExpiringProductsTable(products);
        }

        function updateRecentMovementsTable(movements) {
            const tableBody = document.getElementById('recentMovementsTable');
            tableBody.innerHTML = '';
            
            // Ordenar por data (mais recentes primeiro) e pegar os 5 primeiros
            const recentMovements = movements
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            recentMovements.forEach(movement => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(movement.date)}</td>
                    <td>${movement.productName}</td>
                    <td>${movement.movementType}</td>
                    <td>${movement.quantity}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateProductStatusTable(products) {
            const tableBody = document.getElementById('productStatusTable');
            tableBody.innerHTML = '';
            
            products.forEach(product => {
                const vencimento = calcularVencimento(product['Data Fabricação']);
                const status = verificarStatusProduto(vencimento);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.Produto}</td>
                    <td>${product.Lote}</td>
                    <td><span class="${status.class}">${status.status}</span></td>
                    <td>${formatDate(vencimento)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateExpiringProductsTable(products) {
            const tableBody = document.getElementById('expiringProductsTable');
            tableBody.innerHTML = '';
            
            const today = new Date();
            const warningThreshold = new Date();
            warningThreshold.setFullYear(warningThreshold.getFullYear() - 3); // 1 ano antes do vencimento
            
            const expiringProducts = products.filter(product => {
                const vencimento = new Date(calcularVencimento(product['Data Fabricação']));
                return vencimento <= warningThreshold;
            });
            
            expiringProducts.forEach(product => {
                const vencimento = calcularVencimento(product['Data Fabricação']);
                const status = verificarStatusProduto(vencimento);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.Produto}</td>
                    <td>${product.Lote}</td>
                    <td>${product.Quantidade}</td>
                    <td>${formatDate(product['Data Fabricação'])}</td>
                    <td>${formatDate(vencimento)}</td>
                    <td><span class="${status.class}">${status.status}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Módulo Movimentação
        function initializeMovimentacao() {
            console.log("Módulo de Movimentação inicializado");
            
            // Configurar eventos
            setupMovementEvents();
            
            // Carregar produtos para autocomplete
            loadProductsForAutocomplete();
        }

        function setupMovementEvents() {
            // Evento para pesquisa de produto
            document.getElementById('productSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const products = JSON.parse(localStorage.getItem('productsData') || '[]');
                
                const matchingProduct = products.find(p => 
                    p.SKU.toLowerCase().includes(searchTerm) || 
                    p.Produto.toLowerCase().includes(searchTerm)
                );
                
                if (matchingProduct) {
                    fillProductDetails(matchingProduct);
                }
            });
            
            // Evento para tipo de movimento
            document.getElementById('movementType').addEventListener('change', function() {
                updateAvailableQuantity();
                updateBatchOptions();
            });
            
            // Evento para adicionar item
            document.getElementById('addItemBtn').addEventListener('click', addItemToTable);
            
            // Evento para salvar movimentação
            document.getElementById('saveMovementBtn').addEventListener('click', saveMovement);
            
            // Evento para gerar relatório
            document.getElementById('generateReportBtn').addEventListener('click', generatePDFReport);
            
            // Evento para preview de fotos
            document.getElementById('photos').addEventListener('change', handlePhotoPreview);
        }

        function loadProductsForAutocomplete() {
            const products = JSON.parse(localStorage.getItem('productsData') || '[]');
            const productList = document.getElementById('productList');
            
            productList.innerHTML = '';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = `${product.SKU} - ${product.Produto}`;
                productList.appendChild(option);
            });
        }

        function fillProductDetails(product) {
            document.getElementById('productSKU').value = product.SKU;
            document.getElementById('productName').value = product.Produto;
            document.getElementById('productType').value = product.Tipo;
            
            updateAvailableQuantity();
            updateBatchOptions();
        }

        function updateAvailableQuantity() {
            const sku = document.getElementById('productSKU').value;
            const movementType = document.getElementById('movementType').value;
            const products = JSON.parse(localStorage.getItem('productsData') || '[]');
            
            const product = products.find(p => p.SKU === sku);
            
            if (product) {
                if (movementType === 'Saída') {
                    document.getElementById('availableQuantity').value = product.Quantidade;
                } else {
                    document.getElementById('availableQuantity').value = '-';
                }
            } else {
                document.getElementById('availableQuantity').value = '0';
            }
        }

        function updateBatchOptions() {
            const sku = document.getElementById('productSKU').value;
            const movementType = document.getElementById('movementType').value;
            const products = JSON.parse(localStorage.getItem('productsData') || '[]');
            const batchSelect = document.getElementById('batch');
            
            batchSelect.innerHTML = '<option value="">Selecione...</option>';
            
            if (sku) {
                const productBatches = products.filter(p => p.SKU === sku);
                
                productBatches.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.Lote;
                    option.textContent = product.Lote;
                    batchSelect.appendChild(option);
                });
                
                // Para entradas, permitir criar novo lote
                if (movementType === 'Entrada') {
                    const newOption = document.createElement('option');
                    newOption.value = 'new';
                    newOption.textContent = '[Novo Lote]';
                    batchSelect.appendChild(newOption);
                }
            }
        }

        function addItemToTable() {
            // Validar formulário
            if (!validateMovementForm()) return;
            
            // Obter dados do formulário
            const formData = getMovementFormData();
            
            // Adicionar à tabela
            addItemToTableUI(formData);
            
            // Limpar formulário
            clearMovementForm();
            
            // Atualizar contador
            updateItemsCounter();
        }

        function validateMovementForm() {
            const requiredFields = [
                'movementDate', 'movementType', 'productSKU', 
                'batch', 'manufacturingDate', 'quantity'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    alert(`O campo ${field.labels[0].textContent} é obrigatório.`);
                    field.focus();
                    return false;
                }
            }
            
            // Validar quantidade para saída
            const movementType = document.getElementById('movementType').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const availableQuantity = parseInt(document.getElementById('availableQuantity').value) || 0;
            
            if (movementType === 'Saída' && quantity > availableQuantity) {
                alert(`Quantidade insuficiente em estoque. Disponível: ${availableQuantity}`);
                return false;
            }
            
            return true;
        }

        function getMovementFormData() {
            return {
                date: document.getElementById('movementDate').value,
                movementType: document.getElementById('movementType').value,
                productSKU: document.getElementById('productSKU').value,
                productName: document.getElementById('productName').value,
                productType: document.getElementById('productType').value,
                batch: document.getElementById('batch').value,
                manufacturingDate: document.getElementById('manufacturingDate').value,
                quantity: parseInt(document.getElementById('quantity').value),
                availableQuantity: document.getElementById('availableQuantity').value
            };
        }

        function addItemToTableUI(itemData) {
            const tableBody = document.getElementById('itemsTable');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${itemData.productName}</td>
                <td>${itemData.batch}</td>
                <td>${itemData.quantity}</td>
                <td>${itemData.movementType}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger remove-item">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            // Adicionar dados como atributo para referência
            row.setAttribute('data-item', JSON.stringify(itemData));
            
            tableBody.appendChild(row);
            
            // Configurar evento de remoção
            row.querySelector('.remove-item').addEventListener('click', function() {
                row.remove();
                updateItemsCounter();
            });
        }

        function clearMovementForm() {
            document.getElementById('productSearch').value = '';
            document.getElementById('productSKU').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productType').value = '';
            document.getElementById('availableQuantity').value = '';
            document.getElementById('batch').value = '';
            document.getElementById('manufacturingDate').value = '';
            document.getElementById('quantity').value = '';
        }

        function updateItemsCounter() {
            const itemCount = document.getElementById('itemsTable').children.length;
            document.getElementById('totalItems').textContent = itemCount;
        }

        function handlePhotoPreview(event) {
            const previewContainer = document.getElementById('photoPreview');
            previewContainer.innerHTML = '';
            
            const files = event.target.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione apenas arquivos de imagem.');
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'photo-preview';
                    
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-photo" data-index="${i}">
                            <i class="bi bi-x"></i>
                        </div>
                    `;
                    
                    previewContainer.appendChild(preview);
                    
                    // Configurar evento de remoção
                    preview.querySelector('.remove-photo').addEventListener('click', function() {
                        preview.remove();
                        // Remover arquivo do input (implementação simplificada)
                    });
                };
                
                reader.readAsDataURL(file);
            }
        }

        function saveMovement() {
            const itemsTable = document.getElementById('itemsTable');
            
            if (itemsTable.children.length === 0) {
                alert('Adicione pelo menos um item antes de salvar.');
                return;
            }
            
            // Coletar todos os itens da tabela
            const items = [];
            const rows = itemsTable.querySelectorAll('tr');
            
            rows.forEach(row => {
                const itemData = JSON.parse(row.getAttribute('data-item'));
                items.push(itemData);
            });
            
            // Processar movimentação
            processMovement(items);
            
            // Limpar tabela
            itemsTable.innerHTML = '';
            updateItemsCounter();
            
            // Limpar preview de fotos
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photos').value = '';
            
            alert('Movimentação salva com sucesso!');
            
            // Atualizar dashboard
            updateDashboard();
            
            // Atualizar estoque
            updateStockTable();
        }

        function processMovement(items) {
            // Obter dados existentes
            let movements = JSON.parse(localStorage.getItem('movementHistory') || '[]');
            let products = JSON.parse(localStorage.getItem('productsData') || '[]');
            let lastReportNumber = parseInt(localStorage.getItem('lastReportNumber') || '0');
            
            // Gerar número do relatório
            const reportNumber = lastReportNumber + 1;
            
            // Processar cada item
            items.forEach(item => {
                // Criar registro de movimentação
                const movement = {
                    id: movements.length + 1,
                    timestamp: new Date().toISOString(),
                    date: item.date,
                    movementType: item.movementType,
                    productSKU: item.productSKU,
                    productName: item.productName,
                    quantity: item.quantity,
                    productType: item.productType,
                    batch: item.batch,
                    manufacturingDate: item.manufacturingDate,
                    reportNumber: reportNumber
                };
                
                movements.push(movement);
                
                // Atualizar estoque
                if (item.movementType === 'Entrada') {
                    // Para entrada, adicionar ao estoque
                    const existingProduct = products.find(p => 
                        p.SKU === item.productSKU && p.Lote === item.batch
                    );
                    
                    if (existingProduct) {
                        // Atualizar produto existente
                        existingProduct.Quantidade += item.quantity;
                        existingProduct.Entradas += item.quantity;
                    } else {
                        // Criar novo produto
                        const newProduct = {
                            SKU: item.productSKU,
                            Produto: item.productName,
                            Tipo: item.productType,
                            Quantidade: item.quantity,
                            Lote: item.batch,
                            "Data Fabricação": item.manufacturingDate,
                            Entradas: item.quantity,
                            Saídas: 0,
                            id: products.length + 1
                        };
                        
                        products.push(newProduct);
                    }
                } else if (item.movementType === 'Saída') {
                    // Para saída, aplicar FIFO
                    const result = processarSaidaFIFO(item.productSKU, item.quantity, products);
                    
                    if (result.remainingQuantity > 0) {
                        alert(`Atenção: Apenas ${item.quantity - result.remainingQuantity} unidades foram processadas. Quantidade insuficiente em estoque.`);
                    }
                    
                    movement.quantidadeProcessada = item.quantity - result.remainingQuantity;
                    movement.remainingQuantity = result.remainingQuantity;
                    movement.lotesUtilizados = result.lotesUtilizados;
                }
            });
            
            // Criar relatório
            const report = {
                reportNumber: reportNumber,
                date: items[0].date,
                timestamp: new Date().toISOString(),
                items: movements.filter(m => m.reportNumber === reportNumber)
            };
            
            // Salvar dados atualizados
            localStorage.setItem('movementHistory', JSON.stringify(movements));
            localStorage.setItem('productsData', JSON.stringify(products));
            localStorage.setItem('lastReportNumber', reportNumber.toString());
            
            // Adicionar relatório ao histórico
            let reports = JSON.parse(localStorage.getItem('reportsHistory') || '[]');
            reports.push(report);
            localStorage.setItem('reportsHistory', JSON.stringify(reports));
            
            return report;
        }

        function processarSaidaFIFO(productSKU, quantidadeRequerida, products) {
            // Filtrar produtos pelo SKU e ordenar por data de fabricação (mais antigos primeiro)
            const produtosOrdenados = products
                .filter(p => p.SKU === productSKU && p.Quantidade > 0)
                .sort((a, b) => new Date(a['Data Fabricação']) - new Date(b['Data Fabricação']));
            
            let quantidadeRestante = quantidadeRequerida;
            const lotesUtilizados = [];
            
            for (let produto of produtosOrdenados) {
                if (quantidadeRestante <= 0) break;
                
                const quantidadeDisponivel = produto.Quantidade;
                const quantidadeUsar = Math.min(quantidadeRestante, quantidadeDisponivel);
                
                lotesUtilizados.push({
                    lote: produto.Lote,
                    quantidade: quantidadeUsar,
                    disponivelAntes: quantidadeDisponivel
                });
                
                produto.Quantidade -= quantidadeUsar;
                produto.Saídas += quantidadeUsar;
                quantidadeRestante -= quantidadeUsar;
            }
            
            return {
                quantidadeProcessada: quantidadeRequerida - quantidadeRestante,
                lotesUtilizados: lotesUtilizados,
                remainingQuantity: quantidadeRestante
            };
        }

        function generatePDFReport() {
            // Implementação simplificada - em um sistema real, isso geraria um PDF
            alert('Funcionalidade de geração de PDF será implementada aqui');
        }

        // Módulo Estoque
        function initializeEstoque() {
            console.log("Módulo de Estoque inicializado");
            
            // Configurar eventos
            setupStockEvents();
        }

        function setupStockEvents() {
            // Evento para busca
            document.getElementById('filterStockBtn').addEventListener('click', updateStockTable);
            
            // Evento para pressionar Enter na busca
            document.getElementById('searchStock').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    updateStockTable();
                }
            });
        }

        function updateStockTable() {
            const products = JSON.parse(localStorage.getItem('productsData') || '[]');
            const searchTerm = document.getElementById('searchStock').value.toLowerCase();
            
            // Agrupar produtos por SKU
            const groupedProducts = groupProductsBySKU(products);
            
            // Aplicar filtro se houver termo de busca
            const filteredProducts = searchTerm ? 
                groupedProducts.filter(p => 
                    p.SKU.toLowerCase().includes(searchTerm) || 
                    p.Produto.toLowerCase().includes(searchTerm)
                ) : 
                groupedProducts;
            
            // Atualizar tabela
            renderStockTable(filteredProducts);
        }

        function groupProductsBySKU(products) {
            const grouped = {};
            
            products.forEach(product => {
                if (!grouped[product.SKU]) {
                    grouped[product.SKU] = {
                        SKU: product.SKU,
                        Produto: product.Produto,
                        Tipo: product.Tipo,
                        QuantidadeTotal: 0,
                        Lotes: [],
                        expanded: false
                    };
                }
                
                grouped[product.SKU].QuantidadeTotal += product.Quantidade;
                grouped[product.SKU].Lotes.push({
                    Lote: product.Lote,
                    Quantidade: product.Quantidade,
                    "Data Fabricação": product["Data Fabricação"],
                    Entradas: product.Entradas,
                    Saídas: product.Saídas
                });
            });
            
            return Object.values(grouped);
        }

        function renderStockTable(groupedProducts) {
            const tableBody = document.getElementById('stockTable');
            tableBody.innerHTML = '';
            
            groupedProducts.forEach(group => {
                // Linha principal (agrupada)
                const mainRow = document.createElement('tr');
                mainRow.className = 'stock-group';
                
                mainRow.innerHTML = `
                    <td>
                        <button class="btn btn-sm btn-outline-primary expand-btn" data-sku="${group.SKU}">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </td>
                    <td>${group.SKU}</td>
                    <td>${group.Produto}</td>
                    <td>${group.Tipo}</td>
                    <td>${group.QuantidadeTotal}</td>
                    <td>${group.Lotes.length}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-success add-batch-btn" data-sku="${group.SKU}">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(mainRow);
                
                // Configurar evento de expansão
                mainRow.querySelector('.expand-btn').addEventListener('click', function() {
                    toggleBatchDetails(group.SKU, this);
                });
                
                // Configurar evento de adicionar lote
                mainRow.querySelector('.add-batch-btn').addEventListener('click', function() {
                    addNewBatch(group.SKU);
                });
                
                // Linhas de detalhes (inicialmente ocultas)
                group.Lotes.forEach(lote => {
                    const vencimento = calcularVencimento(lote["Data Fabricação"]);
                    const status = verificarStatusProduto(vencimento);
                    
                    const detailRow = document.createElement('tr');
                    detailRow.className = `batch-detail ${group.SKU}-detail d-none`;
                    
                    detailRow.innerHTML = `
                        <td></td>
                        <td colspan="2">
                            <strong>Lote:</strong> ${lote.Lote}
                        </td>
                        <td>
                            <strong>Quantidade:</strong> ${lote.Quantidade}
                        </td>
                        <td>
                            <strong>Fabricação:</strong> ${formatDate(lote["Data Fabricação"])}
                        </td>
                        <td>
                            <span class="${status.class}">${status.status}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning edit-batch-btn" data-lote="${lote.Lote}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-batch-btn" data-lote="${lote.Lote}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(detailRow);
                    
                    // Configurar eventos dos botões de ação
                    detailRow.querySelector('.edit-batch-btn').addEventListener('click', function() {
                        editBatch(lote.Lote);
                    });
                    
                    detailRow.querySelector('.delete-batch-btn').addEventListener('click', function() {
                        deleteBatch(lote.Lote);
                    });
                });
            });
        }

        function toggleBatchDetails(sku, button) {
            const details = document.querySelectorAll(`.${sku}-detail`);
            const icon = button.querySelector('i');
            
            if (details[0].classList.contains('d-none')) {
                // Expandir
                details.forEach(detail => detail.classList.remove('d-none'));
                icon.className = 'bi bi-chevron-down';
            } else {
                // Recolher
                details.forEach(detail => detail.classList.add('d-none'));
                icon.className = 'bi bi-chevron-right';
            }
        }

        function addNewBatch(sku) {
            alert(`Funcionalidade para adicionar novo lote ao produto ${sku} será implementada aqui`);
        }

        function editBatch(lote) {
            alert(`Funcionalidade para editar lote ${lote} será implementada aqui`);
        }

        function deleteBatch(lote) {
            if (confirm(`Tem certeza que deseja excluir o lote ${lote}?`)) {
                // Implementar exclusão do lote
                alert(`Lote ${lote} excluído com sucesso`);
                updateStockTable();
            }
        }

        // Módulo Produtos Segregados
        function initializeProdutosSegregados() {
            console.log("Módulo de Produtos Segregados inicializado");
            
            // Configurar eventos
            setupSegregatedEvents();
        }

        function setupSegregatedEvents() {
            // Evento para novo produto segregado
            document.getElementById('newSegregatedBtn').addEventListener('click', showSegregatedModal);
            
            // Evento para salvar produto segregado
            document.getElementById('saveSegregatedBtn').addEventListener('click', saveSegregatedProduct);
            
            // Evento para motivo de segregação
            document.getElementById('segregatedReason').addEventListener('change', function() {
                const otherReasonContainer = document.getElementById('otherReasonContainer');
                if (this.value === 'outros') {
                    otherReasonContainer.style.display = 'block';
                } else {
                    otherReasonContainer.style.display = 'none';
                }
            });
            
            // Evento para contador de caracteres
            document.getElementById('segregatedObservations').addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });
            
            // Evento para aplicar filtros
            document.getElementById('applyFiltersBtn').addEventListener('click', updateSegregatedTable);
            
            // Evento para limpar filtros
            document.getElementById('clearFiltersBtn').addEventListener('click', clearSegregatedFilters);
            
            // Evento para preview de fotos
            document.getElementById('segregatedPhotos').addEventListener('change', handleSegregatedPhotoPreview);
        }

        function showSegregatedModal() {
            // Limpar formulário
            document.getElementById('segregatedForm').reset();
            document.getElementById('segregatedId').value = '';
            document.getElementById('segregatedModalTitle').textContent = 'Novo Produto Segregado';
            document.getElementById('segregatedStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('segregatedStatus').value = 'ativo';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('segregatedPhotoPreview').innerHTML = '';
            document.getElementById('otherReasonContainer').style.display = 'none';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('segregatedModal'));
            modal.show();
        }

        function saveSegregatedProduct() {
            // Validar formulário
            if (!validateSegregatedForm()) return;
            
            // Obter dados do formulário
            const formData = getSegregatedFormData();
            
            // Salvar produto segregado
            saveSegregatedToStorage(formData);
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('segregatedModal'));
            modal.hide();
            
            // Atualizar tabela
            updateSegregatedTable();
            
            alert('Produto segregado salvo com sucesso!');
        }

        function validateSegregatedForm() {
            const requiredFields = [
                'segregatedSKU', 'segregatedProduct', 'segregatedType', 
                'segregatedQuantity', 'segregatedBatch', 'segregatedManufacturingDate',
                'segregatedReason', 'segregatedLocation', 'segregatedResponsible',
                'segregatedStartDate', 'segregatedStatus'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    alert(`O campo ${field.labels[0].textContent} é obrigatório.`);
                    field.focus();
                    return false;
                }
            }
            
            // Validar fotos (mínimo 1)
            const photoInput = document.getElementById('segregatedPhotos');
            if (photoInput.files.length === 0) {
                alert('É obrigatório adicionar pelo menos uma foto.');
                return false;
            }
            
            return true;
        }

        function getSegregatedFormData() {
            const reason = document.getElementById('segregatedReason').value;
            const otherReason = document.getElementById('segregatedOtherReason').value;
            
            return {
                id: document.getElementById('segregatedId').value || Date.now(),
                SKU: document.getElementById('segregatedSKU').value,
                Produto: document.getElementById('segregatedProduct').value,
                Tipo: document.getElementById('segregatedType').value,
                Quantidade: parseInt(document.getElementById('segregatedQuantity').value),
                Lote: document.getElementById('segregatedBatch').value,
                DataFabricacao: document.getElementById('segregatedManufacturingDate').value,
                MotivoSegregacao: reason === 'outros' ? otherReason : reason,
                Localizacao: document.getElementById('segregatedLocation').value,
                Responsavel: document.getElementById('segregatedResponsible').value,
                StatusSegregacao: document.getElementById('segregatedStatus').value,
                DataInicioSegregacao: document.getElementById('segregatedStartDate').value,
                DataPrevisaoLiberacao: document.getElementById('segregatedExpectedDate').value,
                DataFimSegregacao: document.getElementById('segregatedStatus').value !== 'ativo' ? 
                    new Date().toISOString().split('T')[0] : '',
                Observacoes: document.getElementById('segregatedObservations').value,
                Fotos: [], // Serão processadas separadamente
                Documentos: [],
                Historico: [],
                DataCriacao: document.getElementById('segregatedId').value ? 
                    '' : new Date().toISOString().split('T')[0],
                UsuarioCriacao: 'Usuário Atual',
                DataUltimaAtualizacao: new Date().toISOString().split('T')[0],
                UsuarioUltimaAtualizacao: 'Usuário Atual'
            };
        }

        function saveSegregatedToStorage(formData) {
            let segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            
            if (formData.id && document.getElementById('segregatedId').value) {
                // Atualizar produto existente
                const index = segregatedProducts.findIndex(p => p.id == formData.id);
                if (index !== -1) {
                    segregatedProducts[index] = formData;
                }
            } else {
                // Adicionar novo produto
                formData.id = Date.now();
                segregatedProducts.push(formData);
            }
            
            localStorage.setItem('segregatedProducts', JSON.stringify(segregatedProducts));
        }

        function handleSegregatedPhotoPreview(event) {
            const previewContainer = document.getElementById('segregatedPhotoPreview');
            previewContainer.innerHTML = '';
            
            const files = event.target.files;
            
            for (let i = 0; i < files.length && i < 5; i++) {
                const file = files[i];
                
                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione apenas arquivos de imagem.');
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'photo-preview';
                    
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-photo" data-index="${i}">
                            <i class="bi bi-x"></i>
                        </div>
                    `;
                    
                    previewContainer.appendChild(preview);
                    
                    // Configurar evento de remoção
                    preview.querySelector('.remove-photo').addEventListener('click', function() {
                        preview.remove();
                        // Remover arquivo do input (implementação simplificada)
                    });
                };
                
                reader.readAsDataURL(file);
            }
        }

        function updateSegregatedTable() {
            const segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            
            // Aplicar filtros
            const filteredProducts = applySegregatedFilters(segregatedProducts);
            
            // Renderizar tabela
            renderSegregatedTable(filteredProducts);
        }

        function applySegregatedFilters(products) {
            const statusFilter = document.getElementById('filterStatus').value;
            const reasonFilter = document.getElementById('filterReason').value;
            const responsibleFilter = document.getElementById('filterResponsible').value.toLowerCase();
            const dateFilter = document.getElementById('filterDate').value;
            
            return products.filter(product => {
                // Filtro por status
                if (statusFilter && product.StatusSegregacao !== statusFilter) {
                    return false;
                }
                
                // Filtro por motivo
                if (reasonFilter && product.MotivoSegregacao !== reasonFilter) {
                    return false;
                }
                
                // Filtro por responsável
                if (responsibleFilter && !product.Responsavel.toLowerCase().includes(responsibleFilter)) {
                    return false;
                }
                
                // Filtro por data
                if (dateFilter && product.DataInicioSegregacao !== dateFilter) {
                    return false;
                }
                
                return true;
            });
        }

        function clearSegregatedFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterReason').value = '';
            document.getElementById('filterResponsible').value = '';
            document.getElementById('filterDate').value = '';
            
            updateSegregatedTable();
        }

        function renderSegregatedTable(products) {
            const tableBody = document.getElementById('segregatedTable');
            tableBody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                
                // Determinar badge de status
                let statusBadge = '';
                if (product.StatusSegregacao === 'ativo') {
                    statusBadge = '<span class="badge badge-status-ativo">Ativo</span>';
                } else if (product.StatusSegregacao === 'liberado') {
                    statusBadge = '<span class="badge badge-status-liberado">Liberado</span>';
                } else if (product.StatusSegregacao === 'descartado') {
                    statusBadge = '<span class="badge badge-status-descartado">Descartado</span>';
                }
                
                row.innerHTML = `
                    <td>${statusBadge}</td>
                    <td>${product.SKU}</td>
                    <td>${product.Produto}</td>
                    <td>${product.Lote}</td>
                    <td>${product.Quantidade}</td>
                    <td>${product.MotivoSegregacao}</td>
                    <td>${product.Localizacao}</td>
                    <td>${product.Responsavel}</td>
                    <td>${formatDate(product.DataInicioSegregacao)}</td>
                    <td>${formatDate(product.DataPrevisaoLiberacao)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-segregated-btn" data-id="${product.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning edit-segregated-btn" data-id="${product.id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-segregated-btn" data-id="${product.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                
                // Configurar eventos dos botões de ação
                row.querySelector('.view-segregated-btn').addEventListener('click', function() {
                    viewSegregatedProduct(product.id);
                });
                
                row.querySelector('.edit-segregated-btn').addEventListener('click', function() {
                    editSegregatedProduct(product.id);
                });
                
                row.querySelector('.delete-segregated-btn').addEventListener('click', function() {
                    deleteSegregatedProduct(product.id);
                });
            });
        }

        function viewSegregatedProduct(id) {
            alert(`Funcionalidade para visualizar produto segregado ${id} será implementada aqui`);
        }

        function editSegregatedProduct(id) {
            const segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
            const product = segregatedProducts.find(p => p.id == id);
            
            if (product) {
                // Preencher formulário com dados do produto
                document.getElementById('segregatedId').value = product.id;
                document.getElementById('segregatedSKU').value = product.SKU;
                document.getElementById('segregatedProduct').value = product.Produto;
                document.getElementById('segregatedType').value = product.Tipo;
                document.getElementById('segregatedQuantity').value = product.Quantidade;
                document.getElementById('segregatedBatch').value = product.Lote;
                document.getElementById('segregatedManufacturingDate').value = product.DataFabricacao;
                document.getElementById('segregatedReason').value = product.MotivoSegregacao;
                document.getElementById('segregatedLocation').value = product.Localizacao;
                document.getElementById('segregatedResponsible').value = product.Responsavel;
                document.getElementById('segregatedStatus').value = product.StatusSegregacao;
                document.getElementById('segregatedStartDate').value = product.DataInicioSegregacao;
                document.getElementById('segregatedExpectedDate').value = product.DataPrevisaoLiberacao;
                document.getElementById('segregatedObservations').value = product.Observacoes || '';
                document.getElementById('charCount').textContent = (product.Observacoes || '').length;
                
                // Mostrar modal
                document.getElementById('segregatedModalTitle').textContent = 'Editar Produto Segregado';
                const modal = new bootstrap.Modal(document.getElementById('segregatedModal'));
                modal.show();
            }
        }

        function deleteSegregatedProduct(id) {
            if (confirm('Tem certeza que deseja excluir este produto segregado?')) {
                let segregatedProducts = JSON.parse(localStorage.getItem('segregatedProducts') || '[]');
                segregatedProducts = segregatedProducts.filter(p => p.id != id);
                localStorage.setItem('segregatedProducts', JSON.stringify(segregatedProducts));
                
                updateSegregatedTable();
                alert('Produto segregado excluído com sucesso!');
            }
        }

        // Módulo Paletes
        function initializePaletes() {
            console.log("Módulo de Paletes inicializado");
            
            // Configurar eventos
            setupPaletesEvents();
            
            // Atualizar tabela
            updatePaletesTable();
        }

        function setupPaletesEvents() {
            // Evento para nova movimentação de palete
            document.getElementById('newPaleteBtn').addEventListener('click', showPaleteModal);
            
            // Evento para salvar movimentação de palete
            document.getElementById('savePaleteBtn').addEventListener('click', savePaleteMovement);
        }

        function showPaleteModal() {
            // Limpar formulário
            document.getElementById('paleteForm').reset();
            document.getElementById('paleteDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paleteModalTitle').textContent = 'Nova Movimentação de Palete';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('paleteModal'));
            modal.show();
        }

        function savePaleteMovement() {
            // Validar formulário
            if (!validatePaleteForm()) return;
            
            // Obter dados do formulário
            const formData = getPaleteFormData();
            
            // Salvar movimentação de palete
            savePaleteToStorage(formData);
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('paleteModal'));
            modal.hide();
            
            // Atualizar tabela
            updatePaletesTable();
            
            alert('Movimentação de palete salva com sucesso!');
        }

        function validatePaleteForm() {
            const requiredFields = ['paleteDate', 'paleteType', 'paleteMovement', 'paleteQuantity'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    alert(`O campo ${field.labels[0].textContent} é obrigatório.`);
                    field.focus();
                    return false;
                }
            }
            
            return true;
        }

        function getPaleteFormData() {
            return {
                id: Date.now(),
                date: document.getElementById('paleteDate').value,
                tipoPalete: document.getElementById('paleteType').value,
                tipoMovimento: document.getElementById('paleteMovement').value,
                quantidade: parseInt(document.getElementById('paleteQuantity').value),
                timestamp: new Date().toISOString()
            };
        }

        function savePaleteToStorage(formData) {
            let paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Gerar número do relatório
            let lastReportNumber = parseInt(localStorage.getItem('lastPaletesReportNumber') || '0');
            const reportNumber = lastReportNumber + 1;
            
            // Adicionar número do relatório aos dados
            formData.reportNumber = reportNumber;
            
            // Salvar dados
            paletesData.push(formData);
            localStorage.setItem('paletesData', JSON.stringify(paletesData));
            localStorage.setItem('lastPaletesReportNumber', reportNumber.toString());
        }

        function updatePaletesTable() {
            const paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
            
            // Agrupar por data
            const groupedByDate = groupPaletesByDate(paletesData);
            
            // Renderizar accordion
            renderPaletesAccordion(groupedByDate);
        }

        function groupPaletesByDate(paletesData) {
            const grouped = {};
            
            paletesData.forEach(palete => {
                if (!grouped[palete.date]) {
                    grouped[palete.date] = [];
                }
                grouped[palete.date].push(palete);
            });
            
            return grouped;
        }

        function renderPaletesAccordion(groupedPaletes) {
            const accordion = document.getElementById('paletesAccordion');
            accordion.innerHTML = '';
            
            // Ordenar datas (mais recentes primeiro)
            const sortedDates = Object.keys(groupedPaletes).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach((date, index) => {
                const paletes = groupedPaletes[date];
                
                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                
                // Calcular totais
                const entradas = paletes
                    .filter(p => p.tipoMovimento === 'Entrada')
                    .reduce((sum, p) => sum + p.quantidade, 0);
                
                const saidas = paletes
                    .filter(p => p.tipoMovimento === 'Saída')
                    .reduce((sum, p) => sum + p.quantidade, 0);
                
                accordionItem.innerHTML = `
                    <h2 class="accordion-header" id="heading${index}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                            <strong>${formatDate(date)}</strong>
                            <span class="badge bg-primary ms-2">Relatório #${paletes[0].reportNumber}</span>
                            <span class="badge bg-success ms-2">Entradas: ${entradas}</span>
                            <span class="badge bg-warning ms-2">Saídas: ${saidas}</span>
                        </button>
                    </h2>
                    <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Tipo de Palete</th>
                                            <th>Movimento</th>
                                            <th>Quantidade</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${paletes.map(palete => `
                                            <tr>
                                                <td>${palete.tipoPalete}</td>
                                                <td>
                                                    <span class="badge ${palete.tipoMovimento === 'Entrada' ? 'bg-success' : 'bg-warning'}">
                                                        ${palete.tipoMovimento}
                                                    </span>
                                                </td>
                                                <td>${palete.quantidade}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-warning edit-palete-btn" data-id="${palete.id}">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger delete-palete-btn" data-id="${palete.id}">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                accordion.appendChild(accordionItem);
                
                // Configurar eventos dos botões de ação
                accordionItem.querySelectorAll('.edit-palete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        editPaleteMovement(this.getAttribute('data-id'));
                    });
                });
                
                accordionItem.querySelectorAll('.delete-palete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        deletePaleteMovement(this.getAttribute('data-id'));
                    });
                });
            });
        }

        function editPaleteMovement(id) {
            alert(`Funcionalidade para editar movimentação de palete ${id} será implementada aqui`);
        }

        function deletePaleteMovement(id) {
            if (confirm('Tem certeza que deseja excluir esta movimentação de palete?')) {
                let paletesData = JSON.parse(localStorage.getItem('paletesData') || '[]');
                paletesData = paletesData.filter(p => p.id != id);
                localStorage.setItem('paletesData', JSON.stringify(paletesData));
                
                updatePaletesTable();
                alert('Movimentação de palete excluída com sucesso!');
            }
        }

        // Módulo Relatórios
        function initializeRelatorios() {
            console.log("Módulo de Relatórios inicializado");
            
            // Configurar eventos
            setupReportsEvents();
            
            // Atualizar tabela
            updateReportsTable();
        }

        function setupReportsEvents() {
            // Evento para filtrar relatórios
            document.getElementById('filterReportsBtn').addEventListener('click', updateReportsTable);
            
            // Evento para exportar relatórios
            document.getElementById('exportReportsBtn').addEventListener('click', exportReports);
        }

        function updateReportsTable() {
            const reports = JSON.parse(localStorage.getItem('reportsHistory') || '[]');
            const dateFilter = document.getElementById('reportDateFilter').value;
            
            // Aplicar filtro de data se especificado
            const filteredReports = dateFilter ? 
                reports.filter(r => r.date === dateFilter) : 
                reports;
            
            // Ordenar por data (mais recentes primeiro)
            filteredReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Renderizar tabela
            renderReportsTable(filteredReports);
        }

        function renderReportsTable(reports) {
            const tableBody = document.getElementById('reportsTable');
            tableBody.innerHTML = '';
            
            reports.forEach(report => {
                const row = document.createElement('tr');
                
                // Calcular totais
                const entradas = report.items
                    .filter(item => item.movementType === 'Entrada')
                    .reduce((sum, item) => sum + item.quantity, 0);
                
                const saidas = report.items
                    .filter(item => item.movementType === 'Saída')
                    .reduce((sum, item) => sum + item.quantity, 0);
                
                row.innerHTML = `
                    <td>#${report.reportNumber}</td>
                    <td>${formatDate(report.date)}</td>
                    <td>${report.items.length} itens</td>
                    <td>
                        <span class="badge bg-success">Entradas: ${entradas}</span>
                        <span class="badge bg-warning">Saídas: ${saidas}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-report-btn" data-id="${report.reportNumber}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success pdf-report-btn" data-id="${report.reportNumber}">
                            <i class="bi bi-file-earmark-pdf"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info excel-report-btn" data-id="${report.reportNumber}">
                            <i class="bi bi-file-earmark-excel"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                
                // Configurar eventos dos botões de ação
                row.querySelector('.view-report-btn').addEventListener('click', function() {
                    viewReport(this.getAttribute('data-id'));
                });
                
                row.querySelector('.pdf-report-btn').addEventListener('click', function() {
                    generatePDFReport(this.getAttribute('data-id'));
                });
                
                row.querySelector('.excel-report-btn').addEventListener('click', function() {
                    generateExcelReport(this.getAttribute('data-id'));
                });
            });
        }

        function viewReport(reportNumber) {
            const reports = JSON.parse(localStorage.getItem('reportsHistory') || '[]');
            const report = reports.find(r => r.reportNumber == reportNumber);
            
            if (report) {
                // Criar modal para visualização do relatório
                const modalContent = `
                    <div class="modal-header">
                        <h5 class="modal-title">Relatório #${report.reportNumber} - ${formatDate(report.date)}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Lote</th>
                                        <th>Movimento</th>
                                        <th>Quantidade</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.items.map(item => `
                                        <tr>
                                            <td>${item.productName}</td>
                                            <td>${item.batch}</td>
                                            <td>
                                                <span class="badge ${item.movementType === 'Entrada' ? 'bg-success' : 'bg-warning'}">
                                                    ${item.movementType}
                                                </span>
                                            </td>
                                            <td>${item.quantity}</td>
                                            <td>${item.productType}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                `;
                
                // Criar modal dinamicamente
                const modalContainer = document.createElement('div');
                modalContainer.className = 'modal fade';
                modalContainer.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            ${modalContent}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalContainer);
                
                const modal = new bootstrap.Modal(modalContainer);
                modal.show();
                
                // Remover modal do DOM após fechar
                modalContainer.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalContainer);
                });
            }
        }

        function generatePDFReport(reportNumber) {
            alert(`Funcionalidade para gerar PDF do relatório ${reportNumber} será implementada aqui`);
        }

        function generateExcelReport(reportNumber) {
            alert(`Funcionalidade para gerar Excel do relatório ${reportNumber} será implementada aqui`);
        }

        function exportReports() {
            alert('Funcionalidade para exportar todos os relatórios será implementada aqui');
        }
    </script>
</body>
</html>
